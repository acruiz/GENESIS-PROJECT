<?php
$array = [
"index3db7.html&amp;d=1850",
"index93b1.html&amp;d=1852", 
"index3e77.html&amp;d=1853", 
"indexdc3f.html&amp;d=1854", 
"index0933.html&amp;d=1855", 
"index5109.html&amp;d=1856", 
"indexfb53.html&amp;d=1859", 
"index273d.html&amp;d=1860", 
"index53f0.html&amp;d=1861", 
"index921e.html&amp;d=1862", 
"index4444.html&amp;d=1864", 
"index64d3.html&amp;d=1865", 
"index18f4.html&amp;d=1866", 
"index508e.html&amp;d=1867", 
"indexfb09.html&amp;d=1868", 
"indexbf13.html&amp;d=1870", 
"index37b6.html&amp;d=1872", 
"index20c8.html&amp;d=1873", 
"index8342.html&amp;d=1874", 
"index0ff1.html&amp;d=1875", 
"index77af.html&amp;d=1876", 
"indexa3d0.html&amp;d=1877", 
"index0226.html&amp;d=1878", 
"index7034.html&amp;d=1879", 
"indexe5bc.html&amp;d=1882", 
"indexa9ca.html&amp;d=1889", 
"index0c0e.html&amp;d=1895", 
"index9a4d.html&amp;d=1896", 
"index3452.html&amp;d=1897", 
"index4337.html&amp;d=1898", 
"index9c88.html&amp;d=1899", 
"index9354.html&amp;d=1901", 
"indexf601.html&amp;d=1902", 
"indexcb7f.html&amp;d=1905", 
"indexb446.html&amp;d=1907", 
"index30d6.html&amp;d=1909", 
"index1154.html&amp;d=1910", 
"index9996.html&amp;d=1912", 
"index6571.html&amp;d=1913", 
"index86ab.html&amp;d=1916", 
"index78fa.html&amp;d=1917", 
"index1fcb.html&amp;d=1920", 
"index5fd9.html&amp;d=1921", 
"indexdb95.html&amp;d=1922", 
"indexa457.html&amp;d=1923", 
"index9724.html&amp;d=1924", 
"index936d.html&amp;d=1925", 
"index5806.html&amp;d=1926", 
"index5b45.html&amp;d=1927", 
"index7275.html&amp;d=1928", 
"indexdc61.html&amp;d=1929", 
"index604c.html&amp;d=1930", 
"indexd717.html&amp;d=1931", 
"indexdcd4.html&amp;d=1932", 
"indexbdb7.html&amp;d=1933", 
"index250e.html&amp;d=1934", 
"index2767.html&amp;d=1935", 
"index3228.html&amp;d=1936", 
"indexa4f6.html&amp;d=1937", 
"indexdb2a.html&amp;d=1938", 
"index5c52.html&amp;d=1939", 
"index8b2a.html&amp;d=1940", 
"indexa801.html&amp;d=1941", 
"index9ec0.html&amp;d=1942", 
"index3d9a.html&amp;d=1943", 
"index0383.html&amp;d=1944", 
"indexdfaa.html&amp;d=1945", 
"indexae63.html&amp;d=1946", 
"index44d4.html&amp;d=1947", 
"index45ae.html&amp;d=1948", 
"indexd974.html&amp;d=1949", 
"indexa8e5.html&amp;d=1950", 
"indexff32.html&amp;d=1951", 
"index3188.html&amp;d=1952", 
"index764a.html&amp;d=1953", 
"index1e4f.html&amp;d=1954", 
"indexc90a.html&amp;d=1955", 
"indexbbf6.html&amp;d=1956", 
"index4c8b.html&amp;d=1957", 
"indexdf35.html&amp;d=1958", 
"index4340.html&amp;d=1959", 
"indexfd34.html&amp;d=1960", 
"indexce4f.html&amp;d=1961", 
"index8a82.html&amp;d=1962", 
"indexd0a7.html&amp;d=1963", 
"index6a1c.html&amp;d=1964", 
"index4f68.html&amp;d=1965", 
"index632f.html&amp;d=1966", 
"indexf81c.html&amp;d=1968", 
"index7414.html&amp;d=1969", 
"index6658.html&amp;d=1970", 
"indexb92a.html&amp;d=1971", 
"index05ea.html&amp;d=1972", 
"index5da3.html&amp;d=1973", 
"index626c.html&amp;d=1974", 
"indexc4f8.html&amp;d=1975", 
"index760f.html&amp;d=1976", 
"index7a53.html&amp;d=1977", 
"indexa9f8.html&amp;d=1978", 
"index81a1.html&amp;d=1979", 
"index52ca.html&amp;d=1981", 
"index1a6a.html&amp;d=1982", 
"indexf068.html&amp;d=1983", 
"index0bf2.html&amp;d=1984", 
"index7942.html&amp;d=1985", 
"indexa1bb.html&amp;d=1986", 
"index54ed.html&amp;d=1987", 
"index2f62.html&amp;d=1988", 
"indexf91f.html&amp;d=1989", 
"index82db.html&amp;d=1990", 
"index566c.html&amp;d=1991", 
"index548e.html&amp;d=1992", 
"indexcfb2.html&amp;d=1993", 
"index2ba1.html&amp;d=1994", 
"index50cc.html&amp;d=1995", 
"indexd5e2.html&amp;d=1997", 
"indexa914.html&amp;d=1998", 
"index09d9.html&amp;d=1999", 
"indexeba4.html&amp;d=2000", 
"index981f.html&amp;d=2001", 
"indexc7ef.html&amp;d=2002", 
"index0fbc.html&amp;d=2003", 
"index7f93.html&amp;d=2004", 
"indexd42b.html&amp;d=2005", 
"index26c6.html&amp;d=2006", 
"index3ac1.html&amp;d=2007", 
"index4bf8.html&amp;d=2008"
];

$bd = new PDO('mysql:host=localhost;dbname=segells', "root", "");
for ($data = 0; $data <= sizeof($array); $data++) {
	$url = "http://localhost/segells/philatelie/basededonnees/".$array[$data];
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $url);
	curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)');
	curl_setopt($ch, CURLOPT_HTTPHEADER, array("Accept-Language: es-es,en"));
	curl_setopt($ch, CURLOPT_TIMEOUT, 100);
	//curl_setopt($ch, CURLOPT_FOLLOWLOCATION,1);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	$result = curl_exec($ch);
	$error = curl_error($ch);
	curl_close($ch); 

	//preg_match_all("(<td class=\"bL bB maintd\">1931</td>(.*)</table>)siU", $result , $title);
	preg_match_all("(<tr class=\"bddCouleurTimbre\">(.*)</table>)siU", $result , $title);//per a saber quantes imatges hi ha
    //var_dump($title); //var_dump dirà quantes imatges hi ha a la pàgina
	$num_segells = count($title[0]);
	//echo $num_segells;


/*$mysqli = new mysqli("domini", "user", "pass", "taula");//USAR PDO!!!!
if ($mysqli->connect_errno) {
    echo "Falla la conexió MySQL: (" . $mysqli->connect_errno . ") " . $mysqli->connect_error;
}*/
$dir ="";
for ($x = 0; $x < $num_segells; $x++) {
	for ($y = 0; $y <= 900; $y++) {
    $dir .= $title[0][$x][$y]; //guardo tota la url a dir
} 
//f = foto; a = any; p = pais; c = cataleg; y = Yvert-et-Tellier; e = Edifil; m = Michel; s = Scott;
preg_match("(src='(.*)')siU", $dir, $f); //trec tot el que hi ha abans del http
preg_match("(<td class=\"bL bB maintd\">(.*)</td>)siU", $dir, $a); //agafo l'any
preg_match("(scans/(.*)/)siU", $dir, $p); //agafo el pais
preg_match("(Yvert-et-Tellier</td><td align=\"right\">(.*?)</td>)", $dir, $y); //agafo el YT
preg_match("(Edifil</td><td align=\"right\">(.*?)</td>)", $dir, $e); //agafo el Ed
preg_match("(Michel</td><td align=\"right\">(.*?)</td>)", $dir, $m); //agafo el Mi
preg_match("(Scott</td><td align=\"right\">(.*?)</td>)", $dir, $s); //agafo el SC
//echo $p[1]."<br><br>";
//echo $a[1]."<br><br>";
//echo $f[1]."<br><br>";
$pais = $p[1];
$any = $a[1];
$img = $f[1];
$img = file_get_contents($img);
$img = base64_encode($img);

$inserir = $bd->prepare('INSERT INTO es (any, imatge, yvert, michel, scott, edifil, id_pais) 
	VALUES (:any, :imatge, :yvert, :michel, :scott, :edifil, "es")');

$inserir->bindParam(":any", $any);
$inserir->bindParam(":imatge", $img);
$inserir->bindParam(":yvert", $y[1]);
$inserir->bindParam(":michel", $m[1]);
$inserir->bindParam(":scott", $s[1]);
$inserir->bindParam(":edifil", $e[1]);

$inserir->execute();

$dir = "";
  }
}
?>
